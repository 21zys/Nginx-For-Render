server {
    # 监听 Render 分配的环境变量 PORT
    listen ${PORT};
    server_name localhost;

    # 优化日志格式，避免记录过多敏感信息（可选）
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # 修改为 /gemini/ 前缀，以便腾出根路径给其他服务
    location /gemini/ {
        # 核心：将请求转发到 Google Gemini API
        # 注意：URL 结尾加了斜杠 /，用于自动剥离 /gemini/ 前缀
        # 即：请求 /gemini/v1beta/... 会变成 upstream 的 /v1beta/...
        proxy_pass https://generativelanguage.googleapis.com/;

        # ------------------------------------------------------------
        # 关键配置：处理 HTTPS 握手和域名验证
        # ------------------------------------------------------------
        
        # 开启 SSL 服务器名称指示 (SNI)，Google 需要这个才能正确握手
        proxy_ssl_server_name on;
        
        # 强制将 Host 头设置为 Google 的域名，而不是你的 Render 域名
        proxy_set_header Host generativelanguage.googleapis.com;

        # ------------------------------------------------------------
        # 转发客户端真实 IP 和协议头 (标准代理设置)
        # ------------------------------------------------------------
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ------------------------------------------------------------
        # 针对 Gemini 流式输出 (Streaming) 的优化
        # ------------------------------------------------------------
        
        # 关闭缓冲，确保打字机效果流畅传输
        proxy_buffering off;
        
        # 禁用缓存
        proxy_cache off;

        # 增加超时时间，防止长对话生成时连接断开
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # ------------------------------------------------------------
        # 解决某些情况下的 HTTP 1.1 问题
        # ------------------------------------------------------------
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # ------------------------------------------------------------
    # 新增：GitHub API 代理
    # 用法：https://你的域名/github/user/repos -> https://api.github.com/user/repos
    # ------------------------------------------------------------
    location /github/ {
        proxy_pass https://api.github.com/;

        # SSL/SNI 配置
        proxy_ssl_server_name on;
        proxy_set_header Host api.github.com;

        # 基础代理头
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # GitHub API 不需要太长的流式超时，但为了防止大文件/大列表传输中断，设置 60s
        proxy_read_timeout 60s;
        
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # ------------------------------------------------------------
    # 新增：OpenAI API 代理 (ChatGPT)
    # 用法：https://你的域名/openai/v1/chat/completions -> https://api.openai.com/v1/chat/completions
    # ------------------------------------------------------------
    location /openai/ {
        proxy_pass https://api.openai.com/;

        # SSL/SNI 配置
        proxy_ssl_server_name on;
        proxy_set_header Host api.openai.com;

        # 基础代理头
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # LLM 专用：流式输出优化
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # ------------------------------------------------------------
    # 新增：xAI API 代理 (Grok)
    # 用法：https://你的域名/xai/v1/chat/completions -> https://api.x.ai/v1/chat/completions
    # ------------------------------------------------------------
    location /xai/ {
        proxy_pass https://api.x.ai/;

        # SSL/SNI 配置
        proxy_ssl_server_name on;
        proxy_set_header Host api.x.ai;

        # 基础代理头
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # LLM 专用：流式输出优化
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # 原有的健康检查端点 (保留作为简单的 HTTP 200 检测)
    location /health {
        access_log off;
        return 200 "OK";
    }
}
