server {
    # 监听 Render 分配的环境变量 PORT
    listen ${PORT};
    server_name localhost;

    # 优化日志格式，避免记录过多敏感信息（可选）
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # ------------------------------------------------------------
    # 根路径处理：返回路由映射表的 JSON
    # ------------------------------------------------------------
    location / {
        default_type application/json;
        # 返回配置的代理规则，方便程序读取或人工查看
        return 200 '{"title":"Nginx-For-Render","description":"通过 Render 平台部署 Nginx 反向代理，代理指定路径的流量到指定域名。目前支持 Gemini、OpenAI、GitHub Rest API、xAI。","proxies":[{"/gemini/":"https://generativelanguage.googleapis.com/"},{"/github/":"https://api.github.com/"},{"/openai/":"https://api.openai.com/"},{"/xai/":"https://api.x.ai/"}]}';
    }

    # ------------------------------------------------------------
    # Gemini API 代理
    # ------------------------------------------------------------
    location /gemini/ {
        # 核心：将请求转发到 Google Gemini API
        # 注意：URL 结尾加了斜杠 /，用于自动剥离 /gemini/ 前缀
        proxy_pass https://generativelanguage.googleapis.com/;

        # SSL/SNI 配置
        proxy_ssl_server_name on;
        proxy_set_header Host generativelanguage.googleapis.com;

        # 基础代理头
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 针对 Gemini 流式输出 (Streaming) 的优化
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # HTTP 1.1 支持
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # ------------------------------------------------------------
    # GitHub API 代理
    # ------------------------------------------------------------
    location /github/ {
        proxy_pass https://api.github.com/;

        proxy_ssl_server_name on;
        proxy_set_header Host api.github.com;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 60s;
        
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # ------------------------------------------------------------
    # OpenAI API 代理 (ChatGPT)
    # ------------------------------------------------------------
    location /openai/ {
        proxy_pass https://api.openai.com/;

        proxy_ssl_server_name on;
        proxy_set_header Host api.openai.com;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # ------------------------------------------------------------
    # xAI API 代理 (Grok)
    # ------------------------------------------------------------
    location /xai/ {
        proxy_pass https://api.x.ai/;

        proxy_ssl_server_name on;
        proxy_set_header Host api.x.ai;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # 原有的健康检查端点
    location /health {
        access_log off;
        return 200 "OK";
    }
}
